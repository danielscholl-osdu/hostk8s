# Local Development Environment
# Use: docker-compose up
# Purpose: Develop and test sample-app without HostK8s

services:
  nginx:
    image: nginx:alpine
    ports:
      - "8081:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - vote
      - result

  vote:
    build:
      context: ./vote
      target: dev
    volumes:
      - ./vote:/usr/local/app
    environment:
      - FLASK_ENV=development
      - REDIS_HOST=redis
      - OPTION_A=HostK8s Stack
      - OPTION_B=HostK8s App
    depends_on:
      - redis

  result:
    build: ./result
    volumes:
      - ./result:/usr/local/app
      - /usr/local/app/node_modules  # Protect node_modules
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgres://postgres:password@db:5432/votes
      - OPTION_A=HostK8s Stack
      - OPTION_B=HostK8s App
    depends_on:
      - db
    command: ["nodemon", "server.js"]

  worker:
    build: ./worker
    environment:
      - REDIS_HOST=redis
      - DATABASE_URL=postgres://postgres:password@db:5432/votes
    depends_on:
      - redis
      - db

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"

  db:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=votes
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
