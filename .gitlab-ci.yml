# GitLab CI/CD Pipeline for OSDU-CI Development Environment
# Hybrid approach: Fast validation + Basic Kubernetes testing

stages:
  - validate
  - test-kubernetes

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: ""

validate-basic:
  stage: validate
  image: alpine:latest
  script:
    - echo "Testing basic GitLab CI validation approach"
    - ls -la
    - test -f Makefile
    - test -f README.md
    - test -d infra/scripts
    - test -d software
    - echo "Basic validation passed"

validate-tools:
  stage: validate  
  image: alpine:latest
  before_script:
    - apk add --no-cache make bash
  script:
    - echo "Testing make targets"
    - make help
    - make -n up
    - make -n test
    - echo "Make targets validated"

test-kubernetes-basic:
  stage: test-kubernetes
  image: docker:27.0.3
  services:
    - name: docker:27.0.3-dind
      alias: docker
      command: ["--privileged"]
  variables:
    FF_NETWORK_PER_BUILD: 1
    KUBECONFIG: "$CI_PROJECT_DIR/data/kubeconfig/config"
    KIND_CONFIG: "minimal"
    METALLB_ENABLED: "false"
    INGRESS_ENABLED: "false" 
    FLUX_ENABLED: "false"
  before_script:
    - echo "Installing Kubernetes tools..."
    - apk add --no-cache make bash curl
    - curl -Lo /usr/local/bin/kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
    - chmod +x /usr/local/bin/kind
    - curl -LO "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
    - chmod +x kubectl && mv kubectl /usr/local/bin/
    - echo "Tools installed"
  script:
    - echo "Testing OSDU-CI minimal cluster functionality..."
    - make up minimal
    - echo "Cluster created successfully"
    - kubectl get nodes
    - echo "Basic Kubernetes testing completed successfully"
  after_script:
    - echo "Cleaning up..."
    - make clean || true
    - echo "Cleanup completed"