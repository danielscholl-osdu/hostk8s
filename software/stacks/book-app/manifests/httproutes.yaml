######################
## HTTPRoutes for Bookinfo Application
## Exposes services through Istio Gateway API
######################

---
# Main route for productpage (entry point)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: bookinfo-productpage
  namespace: bookinfo
  labels:
    app: productpage
    hostk8s.app: bookinfo
spec:
  parentRefs:
  - name: hostk8s-gateway
    namespace: istio-system
  hostnames:
  - "localhost"
  - "bookinfo.hostk8s.local"
  rules:
  # Root path redirects to productpage
  - matches:
    - path:
        type: Exact
        value: /
    filters:
    - type: RequestRedirect
      requestRedirect:
        path:
          type: ReplaceFullPath
          replaceFullPath: /productpage
        statusCode: 301
  # Productpage routes
  - matches:
    - path:
        type: PathPrefix
        value: /productpage
    - path:
        type: Exact
        value: /login
    - path:
        type: Exact
        value: /logout
    backendRefs:
    - name: productpage
      port: 9080

---
# API routes for internal services (optional exposure for testing)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: bookinfo-api
  namespace: bookinfo
  labels:
    app: api
    hostk8s.app: bookinfo
spec:
  parentRefs:
  - name: hostk8s-gateway
    namespace: istio-system
  hostnames:
  - "localhost"
  - "bookinfo.hostk8s.local"
  rules:
  # Details service API
  - matches:
    - path:
        type: PathPrefix
        value: /details
    backendRefs:
    - name: details
      port: 9080
  # Ratings service API
  - matches:
    - path:
        type: PathPrefix
        value: /ratings
    backendRefs:
    - name: ratings
      port: 9080

---
# Reviews service with traffic splitting between versions
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: bookinfo-reviews
  namespace: bookinfo
  labels:
    app: reviews
    hostk8s.app: bookinfo
spec:
  parentRefs:
  - name: hostk8s-gateway
    namespace: istio-system
  hostnames:
  - "localhost"
  - "bookinfo.hostk8s.local"
  rules:
  # Reviews with traffic split (canary deployment example)
  - matches:
    - path:
        type: PathPrefix
        value: /reviews
    backendRefs:
    # v1: No stars (60% traffic)
    - name: reviews-v1
      port: 9080
      weight: 60
    # v2: Black stars (20% traffic)
    - name: reviews-v2
      port: 9080
      weight: 20
    # v3: Red stars (20% traffic)
    - name: reviews-v3
      port: 9080
      weight: 20

---
# Static content route
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: bookinfo-static
  namespace: bookinfo
  labels:
    app: static
    hostk8s.app: bookinfo
spec:
  parentRefs:
  - name: hostk8s-gateway
    namespace: istio-system
  hostnames:
  - "localhost"
  - "bookinfo.hostk8s.local"
  rules:
  # Static content (CSS, JS, images)
  - matches:
    - path:
        type: PathPrefix
        value: /static
    backendRefs:
    - name: productpage
      port: 9080

---
# Health check route
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: bookinfo-health
  namespace: bookinfo
  labels:
    app: health
    hostk8s.app: bookinfo
spec:
  parentRefs:
  - name: hostk8s-gateway
    namespace: istio-system
  hostnames:
  - "localhost"
  - "bookinfo.hostk8s.local"
  rules:
  - matches:
    - path:
        type: Exact
        value: /health
    backendRefs:
    - name: productpage
      port: 9080
