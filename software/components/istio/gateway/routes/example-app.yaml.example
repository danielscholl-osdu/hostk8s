######################
## Example Application Route
## Shows how applications expose services through the gateway
## Copy this file and modify for your application
######################
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: example-app
  namespace: default  # Your app namespace
  labels:
    app: example
    hostk8s.app: example
spec:
  parentRefs:
  - name: hostk8s-gateway
    namespace: istio-system
    sectionName: http  # Use 'https' for TLS

  hostnames:
  - "localhost"
  - "example.hostk8s.local"

  rules:
  # Simple path-based routing
  - matches:
    - path:
        type: PathPrefix
        value: /api
    backendRefs:
    - name: example-api
      port: 8080
      weight: 1

  # Header-based routing
  - matches:
    - path:
        type: PathPrefix
        value: /
      headers:
      - name: x-version
        value: v2
    backendRefs:
    - name: example-v2
      port: 8080

  # Default route with traffic splitting
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: example-v1
      port: 8080
      weight: 90  # 90% traffic
    - name: example-v2
      port: 8080
      weight: 10  # 10% traffic (canary)

  # Request modification
  - matches:
    - path:
        type: PathPrefix
        value: /legacy
    filters:
    - type: URLRewrite
      urlRewrite:
        path:
          type: ReplacePrefixMatch
          replacePrefixMatch: /api/v1
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: X-Legacy-Request
          value: "true"
    backendRefs:
    - name: example-api
      port: 8080

  # Response modification
  - matches:
    - path:
        type: PathPrefix
        value: /secure
    filters:
    - type: ResponseHeaderModifier
      responseHeaderModifier:
        add:
        - name: Strict-Transport-Security
          value: "max-age=31536000; includeSubDomains"
        - name: X-Frame-Options
          value: "DENY"
    backendRefs:
    - name: example-secure
      port: 8443

---
# Optional: ReferenceGrant if the route is in a different namespace
# apiVersion: gateway.networking.k8s.io/v1beta1
# kind: ReferenceGrant
# metadata:
#   name: allow-gateway-routes
#   namespace: istio-system
# spec:
#   from:
#   - group: gateway.networking.k8s.io
#     kind: HTTPRoute
#     namespace: default
#   to:
#   - group: gateway.networking.k8s.io
#     kind: Gateway
#     name: hostk8s-gateway
