######################
## Main Istio Gateway
## This resource automatically deploys gateway pods and services
######################
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: hostk8s-gateway
  namespace: istio-system
  annotations:
    # This Gateway will automatically create:
    # - Service: hostk8s-gateway-istio
    # - Deployment: hostk8s-gateway-istio
    hostk8s.io/description: "Main ingress gateway for HostK8s platform"
spec:
  gatewayClassName: istio

  # HTTP listener for unencrypted traffic
  listeners:
  - name: http
    protocol: HTTP
    port: 80
    hostname: "*"  # Accept all hostnames
    allowedRoutes:
      namespaces:
        from: All  # Allow routes from all namespaces
      kinds:
      - group: gateway.networking.k8s.io
        kind: HTTPRoute
      - group: gateway.networking.k8s.io
        kind: GRPCRoute

  # HTTPS listener for TLS traffic
  - name: https
    protocol: HTTPS
    port: 443
    hostname: "*"  # Accept all hostnames
    tls:
      mode: Terminate
      certificateRefs:
      - kind: Secret
        name: hostk8s-gateway-cert
        namespace: istio-system
    allowedRoutes:
      namespaces:
        from: All  # Allow routes from all namespaces
      kinds:
      - group: gateway.networking.k8s.io
        kind: HTTPRoute
      - group: gateway.networking.k8s.io
        kind: GRPCRoute

  # Additional listener for localhost development
  - name: localhost-http
    protocol: HTTP
    port: 80
    hostname: "localhost"
    allowedRoutes:
      namespaces:
        from: All

  - name: localhost-https
    protocol: HTTPS
    port: 443
    hostname: "localhost"
    tls:
      mode: Terminate
      certificateRefs:
      - kind: Secret
        name: hostk8s-gateway-cert
        namespace: istio-system
    allowedRoutes:
      namespaces:
        from: All
