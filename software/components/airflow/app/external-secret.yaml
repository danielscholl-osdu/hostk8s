# Generated ExternalSecret manifest for airflow
# This file is auto-generated by manage-secrets.py - safe to commit to Git
# Contains no sensitive data - only Vault path references
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: airflow-secrets
  namespace: airflow
  labels:
    hostk8s.io/managed: "true"
    hostk8s.io/contract: "foundation-airflow"
spec:
  refreshInterval: 10s
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: airflow-secrets
    creationPolicy: Owner
  data:
  - secretKey: webserver-secret-key
    remoteRef:
      key: airflow/airflow-secrets
      property: webserver-secret-key
  - secretKey: fernet-key
    remoteRef:
      key: airflow/airflow-secrets
      property: fernet-key
  - secretKey: admin-password
    remoteRef:
      key: airflow/airflow-secrets
      property: admin-password
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: airflow-db-credentials
  namespace: airflow
  labels:
    hostk8s.io/managed: "true"
    hostk8s.io/contract: "foundation-airflow"
spec:
  refreshInterval: 10s
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: airflow-db-credentials
    creationPolicy: Owner
  data:
  - secretKey: username
    remoteRef:
      key: airflow/airflow-db-credentials
      property: username
  - secretKey: password
    remoteRef:
      key: airflow/airflow-db-credentials
      property: password
  - secretKey: host
    remoteRef:
      key: airflow/airflow-db-credentials
      property: host
  - secretKey: database
    remoteRef:
      key: airflow/airflow-db-credentials
      property: database
---
# Create airflow-metadata secret with connection string for Helm chart
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: airflow-metadata
  namespace: airflow
  labels:
    hostk8s.io/managed: "true"
spec:
  refreshInterval: 10s
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: airflow-metadata
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        connection: "postgresql+psycopg2://{{ .username }}:{{ .password }}@{{ .host }}:5432/{{ .database }}"
  dataFrom:
    - extract:
        key: airflow/airflow-db-credentials
