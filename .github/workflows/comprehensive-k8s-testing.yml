name: Comprehensive Kubernetes Testing

on:
  repository_dispatch:
    types: [gitlab-ci-success]
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: false
        default: 'full'
        type: choice
        options:
          - minimal
          - full
          - gitops
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - 'software/**'
      - '.github/workflows/**'

env:
  CLUSTER_NAME: osdu-ci-gh
  KIND_CONFIG: default
  METALLB_ENABLED: true
  INGRESS_ENABLED: true
  FLUX_ENABLED: true

jobs:
  comprehensive-testing:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Log trigger context
        run: |
          echo "ğŸ” Comprehensive testing triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "GitLab Pipeline ID: ${{ github.event.client_payload.gitlab_pipeline_id }}"
            echo "GitLab Commit: ${{ github.event.client_payload.gitlab_commit_sha }}"
            echo "GitLab Ref: ${{ github.event.client_payload.gitlab_ref }}"
            echo "GitLab Pipeline URL: ${{ github.event.client_payload.gitlab_pipeline_url }}"
          fi

      - name: Install tools
        timeout-minutes: 5
        run: |
          echo "ğŸ› ï¸ Installing Kubernetes tools with optimized downloads..."

          # Create downloads directory
          mkdir -p /tmp/downloads

          # Parallel downloads with timeouts
          echo "ğŸ“¥ Starting parallel downloads..."
          (curl --max-time 60 -Lo /tmp/downloads/kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64) &
          (curl --max-time 60 -LO https://dl.k8s.io/release/v1.33.2/bin/linux/amd64/kubectl && mv kubectl /tmp/downloads/) &
          (curl --max-time 60 -L https://get.helm.sh/helm-v3.16.1-linux-amd64.tar.gz | tar xz && mv linux-amd64/helm /tmp/downloads/) &
          (curl --max-time 60 -L https://github.com/fluxcd/flux2/releases/download/v2.4.0/flux_2.4.0_linux_amd64.tar.gz | tar xz && mv flux /tmp/downloads/) &

          # Wait for all downloads to complete
          wait

          # Install all at once
          sudo install -o root -g root -m 0755 /tmp/downloads/* /usr/local/bin/

          echo "âœ… Tools installed"
          kind version && kubectl version --client && helm version && flux version --client

      - name: Test minimal cluster
        timeout-minutes: 5
        run: |
          echo "ğŸš€ Testing minimal cluster creation..."

          # Backup original .env file
          cp .env .env.backup 2>/dev/null || true

          # Create minimal .env configuration
          cat > .env.minimal << 'EOF'
          CLUSTER_NAME=osdu-ci-gh
          KIND_CONFIG=minimal
          METALLB_ENABLED=false
          INGRESS_ENABLED=false
          FLUX_ENABLED=false
          APP_DEPLOY=false
          EOF
          mv .env.minimal .env

          echo "ğŸ“Š Minimal cluster configuration:"
          cat .env

          # Add timing
          start_time=$(date +%s)
          timeout 240s make up minimal || {
            echo "âŒ Cluster creation timed out after 4 minutes"
            echo "ğŸ” Debugging information:"
            docker ps
            kind get clusters || true
            kubectl get nodes || true
            kubectl get pods -A || true
            # Restore .env file before exit
            mv .env.backup .env 2>/dev/null || true
            exit 1
          }
          end_time=$(date +%s)
          echo "â±ï¸ Cluster creation took $((end_time - start_time)) seconds"

          kubectl get nodes
          kubectl get pods -A
          echo "âœ… Minimal cluster test passed"
          make clean

          # Restore original .env file
          mv .env.backup .env 2>/dev/null || true

      - name: Test full cluster with GitOps
        timeout-minutes: 10
        run: |
          echo "ğŸš€ Testing full cluster with GitOps..."
          echo "Add-on status: MetalLB=$METALLB_ENABLED, Ingress=$INGRESS_ENABLED, Flux=$FLUX_ENABLED"

          # Add timing
          start_time=$(date +%s)
          make up
          cluster_time=$(date +%s)
          echo "â±ï¸ Cluster creation took $((cluster_time - start_time)) seconds"

          echo "â³ Waiting for cluster to be ready..."
          kubectl wait --for=condition=Ready nodes --all --timeout=300s

          echo "ğŸ“¦ Checking installed components..."
          kubectl get pods -A

          # Test MetalLB
          if [ "$METALLB_ENABLED" = "true" ]; then
            echo "ğŸ” Testing MetalLB..."
            kubectl get pods -n metallb-system
          fi

          # Test Ingress
          if [ "$INGRESS_ENABLED" = "true" ]; then
            echo "ğŸ” Testing NGINX Ingress..."
            kubectl get pods -n ingress-nginx
            kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=controller -n ingress-nginx --timeout=300s
          fi

          # Test Flux GitOps
          if [ "$FLUX_ENABLED" = "true" ]; then
            echo "ğŸ” Testing Flux GitOps..."
            kubectl get pods -n flux-system
            flux get sources git -A
            flux get kustomizations -A
          fi

          echo "âœ… Full cluster test passed"

      - name: Test application deployment
        run: |
          echo "ğŸ“¦ Testing application deployment..."

          # Deploy each sample app
          for app in app1 app2 app3; do
            if [ -d "software/apps/$app" ]; then
              echo "ğŸš€ Deploying $app..."
              make deploy $app
              sleep 30
              kubectl get pods -l app=$app || true
            fi
          done

          echo "âœ… Application deployment tests completed"

      - name: Test connectivity and access
        run: |
          echo "ğŸ” Testing connectivity and access..."

          # Test NodePort access
          echo "Testing NodePort services..."
          kubectl get services --all-namespaces -o wide

          # Test if services are responding
          for svc in $(kubectl get svc -o name | grep -v kubernetes); do
            echo "Checking service: $svc"
            kubectl describe $svc || true
          done

          echo "âœ… Connectivity tests completed"

      - name: Run validation tests
        run: |
          echo "ğŸ§ª Running comprehensive validation tests..."
          make test
          echo "âœ… Validation tests completed"

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          make clean || true
          echo "âœ… Cleanup completed"

      - name: Report results
        if: always()
        run: |
          echo "ğŸ“Š Comprehensive Kubernetes Testing Results:"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… All comprehensive tests passed!"
            echo "âœ… Kind cluster creation: PASSED"
            echo "âœ… GitOps integration: PASSED"
            echo "âœ… Application deployment: PASSED"
            echo "âœ… Connectivity tests: PASSED"
            echo "âœ… Validation tests: PASSED"
          else
            echo "âŒ Some comprehensive tests failed"
            echo "Check logs above for details"
          fi
          echo ""
          echo "ğŸ”— Hybrid Testing Summary:"
          echo "  â€¢ GitLab CI: Fast validation and tooling checks"
          echo "  â€¢ GitHub Actions: Comprehensive Kubernetes testing"
          echo ""
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸ”— Original GitLab Pipeline: ${{ github.event.client_payload.gitlab_pipeline_url }}"
          fi
