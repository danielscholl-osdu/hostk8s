name: OSDU-CI Cluster Testing

run-name: ${{ github.event_name == 'repository_dispatch' && format('GitLab Pipeline {0} - Cluster Testing', github.event.client_payload.gitlab_pipeline_id) || 'OSDU-CI Cluster Testing' }}

on:
  repository_dispatch:
    types: [gitlab-ci-success]
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'GitOps test scenario to run'
        required: false
        default: 'full'
        type: choice
        options:
          - minimal
          - full
          - gitops

jobs:
  cluster-minimal:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    outputs:
      flux_status: ${{ steps.flux_validation.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.gitlab_commit_sha || github.sha }}

      - name: Log GitLab trigger context
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "ğŸ” Cluster testing triggered by GitLab CI"
          echo "GitLab Pipeline ID: ${{ github.event.client_payload.gitlab_pipeline_id }}"
          echo "GitLab Commit: ${{ github.event.client_payload.gitlab_commit_sha }}"
          echo "GitLab Branch: ${{ github.event.client_payload.gitlab_ref }}"
          echo "GitLab Pipeline URL: ${{ github.event.client_payload.gitlab_pipeline_url }}"
          echo ""
          if [ "${{ github.event.client_payload.gitlab_ref }}" = "main" ]; then
            echo "ğŸš€ Main branch detected - Full testing will run (minimal + default clusters)"
          else
            echo "ğŸ”„ PR branch detected - Fast testing will run (minimal cluster only)"
            echo "ğŸ“ Branch: ${{ github.event.client_payload.gitlab_ref }}"
          fi

      - name: Create minimal Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: osdu-ci-minimal
          node_image: kindest/node:v1.33.2
          config: infra/kubernetes/kind-config-minimal.yaml

      - name: Install Flux CLI
        run: |
          echo "ğŸ“¥ Installing Flux CLI..."
          curl -s https://fluxcd.io/install.sh | sudo bash
          flux version --client
          echo "âœ… Flux CLI installed"

      - name: Bootstrap Flux and test basic reconciliation
        id: flux_validation
        run: |
          echo "ğŸš€ Testing basic Flux GitOps reconciliation..."

          # Install Flux system
          echo "ğŸ“¦ Installing Flux system..."
          flux install --timeout=300s

          # Wait for Flux system to be ready
          echo "â³ Waiting for Flux system readiness..."
          kubectl wait --for=condition=ready pod -l app=source-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=kustomize-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=helm-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=notification-controller -n flux-system --timeout=180s

          # Create basic GitRepository source
          echo "ğŸ”— Creating GitRepository source..."
          flux create source git osdu-ci-source \
            --url=https://github.com/danielscholl-osdu/osdu-ci \
            --branch=main \
            --interval=1m \
            --timeout=60s

          # Verify source reconciliation
          echo "â³ Waiting for GitRepository reconciliation..."
          sleep 30
          flux reconcile source git osdu-ci-source --timeout=60s

          # Validate Flux system health
          echo "ğŸ“Š Flux system status:"
          kubectl get pods -n flux-system
          echo ""

          echo "ğŸ“Š GitRepository source status:"
          flux get sources git
          echo ""

          # Check for reconciliation success
          if flux get sources git | grep -q "True"; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Basic Flux reconciliation successful"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Basic Flux reconciliation failed"
            flux logs --all-namespaces
            exit 1
          fi

  cluster-default:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.inputs.test_scenario != 'minimal' }}
    outputs:
      gitops_status: ${{ steps.gitops_validation.outputs.status }}
      reconciliation_summary: ${{ steps.gitops_validation.outputs.summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.gitlab_commit_sha || github.sha }}

      - name: Report GitOps testing start to GitLab
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.gitlab_commit_sha
        run: |
          echo "ğŸ“¤ Reporting GitOps test start to GitLab..."
          curl -X POST \
            -H "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://community.opengroup.org/api/v4/projects/1595/statuses/${{ github.event.client_payload.gitlab_commit_sha }}" \
            -d "{
              \"state\": \"running\",
              \"target_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"description\": \"GitOps reconciliation tests starting...\",
              \"context\": \"github-actions/cluster-testing\"
            }" || echo "âš ï¸ Failed to report to GitLab (non-blocking)"

      - name: Create full Kind cluster with registry
        uses: helm/kind-action@v1
        with:
          cluster_name: osdu-ci-gitops
          node_image: kindest/node:v1.33.2
          config: infra/kubernetes/kind-config.yaml
          registry: true

      - name: Install additional tools
        run: |
          echo "ğŸ“¥ Installing additional tools..."
          curl -s https://fluxcd.io/install.sh | sudo bash
          helm version && flux version --client
          echo "âœ… Additional tools installed"

      - name: Install infrastructure prerequisites
        run: |
          echo "ğŸ—ï¸ Installing infrastructure prerequisites..."

          # Install MetalLB
          echo "ğŸ“¦ Installing MetalLB..."
          kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml
          kubectl wait --namespace metallb-system --for=condition=ready pod --selector=app=metallb --timeout=300s

          # Configure MetalLB IP pool
          kubectl apply -f - <<EOF
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: example
            namespace: metallb-system
          spec:
            addresses:
            - 172.19.255.200-172.19.255.250
          ---
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: empty
            namespace: metallb-system
          EOF

          # Install NGINX Ingress
          echo "ğŸ“¦ Installing NGINX Ingress..."
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=300s

          echo "âœ… Infrastructure prerequisites installed"

      - name: Test complete GitOps reconciliation
        id: gitops_validation
        run: |
          echo "ğŸš€ Testing complete GitOps reconciliation..."

          # Install Flux system
          echo "ğŸ“¦ Installing Flux system..."
          flux install --timeout=300s

          # Wait for Flux system readiness
          echo "â³ Waiting for Flux system readiness..."
          kubectl wait --for=condition=ready pod -l app=source-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=kustomize-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=helm-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=notification-controller -n flux-system --timeout=180s

          # Apply GitOps source configurations
          echo "ğŸ”— Applying GitOps source configurations..."
          if [ -d "software/stamp/sources" ]; then
            # Apply only the actual Kubernetes resources, not kustomization.yaml
            find software/stamp/sources -name "*.yaml" ! -name "kustomization.yaml" -exec kubectl apply -f {} \; || echo "No sources directory found, creating basic source"
          fi

          # Create basic source pointing to the branch being tested
          GITOPS_REPO="${{ github.event.client_payload.gitops_repo || 'https://github.com/danielscholl-osdu/osdu-ci' }}"
          GITOPS_BRANCH="${{ github.event.client_payload.gitlab_ref || 'main' }}"
          echo "ğŸ¯ Creating GitRepository source:"
          echo "   Repository: $GITOPS_REPO"
          echo "   Branch: $GITOPS_BRANCH"
          flux create source git osdu-ci-source \
            --url="$GITOPS_REPO" \
            --branch="$GITOPS_BRANCH" \
            --interval=1m \
            --timeout=60s

          # Apply GitOps application configurations
          echo "ğŸ“¦ Applying GitOps application configurations..."
          if [ -d "software/stamp/apps" ]; then
            # Apply only the actual Kubernetes resources, not kustomization.yaml
            find software/stamp/apps -name "*.yaml" ! -name "kustomization.yaml" -exec kubectl apply -f {} \; || echo "No apps directory found, skipping"
          fi

          # Apply cluster-specific configurations
          echo "ğŸ¯ Applying cluster-specific configurations..."
          if [ -d "software/stamp/clusters/osdu-ci" ]; then
            kubectl apply -f software/stamp/clusters/osdu-ci/ || echo "No cluster-specific configs found, skipping"
          fi

          # Wait for reconciliations
          echo "â³ Waiting for source reconciliations..."
          sleep 60

          echo "ğŸ”„ Triggering reconciliations..."
          flux reconcile source git osdu-ci-source --timeout=120s || true
          flux reconcile source git osdu-ci-self --timeout=120s || true
          flux reconcile source helm bitnami --timeout=120s || true
          flux reconcile source helm nginx-stable --timeout=120s || true
          flux reconcile source helm prometheus-community --timeout=120s || true

          # Validate reconciliation status
          echo "ğŸ“Š GitOps reconciliation status:"
          echo "================================"

          echo "Git Sources:"
          flux get sources git -A
          echo ""

          echo "Helm Sources:"
          flux get sources helm -A || echo "No Helm sources configured"
          echo ""

          echo "Kustomizations:"
          flux get kustomizations -A || echo "No Kustomizations configured"
          echo ""

          echo "Complete GitOps Status:"
          flux get all
          echo ""

          # Check for reconciliation failures
          reconciliation_status="success"
          summary=""

          # Check Git sources for failures (ready=False)
          if flux get sources git -A | grep -E "\s+False\s+" | grep -v "True"; then
            reconciliation_status="failed"
            summary="Git source reconciliation failed"
          # Check Helm sources for failures (ready=False)
          elif flux get sources helm -A 2>/dev/null | grep -E "\s+False\s+" | grep -v "True"; then
            reconciliation_status="failed"
            summary="Helm source reconciliation failed"
          # Check Kustomizations for failures (ready=False)
          elif flux get kustomizations -A 2>/dev/null | grep -E "\s+False\s+" | grep -v "True"; then
            reconciliation_status="failed"
            summary="Kustomization reconciliation failed"
          # Success if all sources are Ready=True
          elif flux get sources git -A | grep -q "True" && flux get sources helm -A | grep -q "True"; then
            summary="GitOps sources reconciled successfully"
          else
            reconciliation_status="failed"
            summary="Unable to determine GitOps reconciliation status"
          fi

          echo "status=$reconciliation_status" >> $GITHUB_OUTPUT
          echo "summary=$summary" >> $GITHUB_OUTPUT

          if [ "$reconciliation_status" = "failed" ]; then
            echo "âŒ GitOps reconciliation failures detected"
            echo "ğŸ” Flux logs:"
            flux logs --all-namespaces --since=5m
            exit 1
          else
            echo "âœ… Complete GitOps reconciliation successful"
          fi

  notify:
    runs-on: ubuntu-latest
    needs: [cluster-minimal, cluster-default]
    if: always()

    steps:
      - name: Report comprehensive GitOps results
        run: |
          echo "ğŸ“Š OSDU-CI Cluster Testing Results:"
          echo "=================================="
          echo ""

          # Determine testing type
          if [ "${{ github.event.client_payload.gitlab_ref }}" = "main" ]; then
            echo "ğŸš€ Main Branch - Standard Testing Results:"
            echo ""
            echo "ğŸ”¹ Minimal Cluster Test: ${{ needs.cluster-minimal.result }}"
            echo "   Status: ${{ needs.cluster-minimal.outputs.flux_status }}"
            echo ""
            echo "ğŸ”¹ Default Cluster Test: ${{ needs.cluster-default.result }}"
            echo "   Status: ${{ needs.cluster-default.outputs.gitops_status }}"
            echo "   Summary: ${{ needs.cluster-default.outputs.reconciliation_summary }}"
          else
            echo "ğŸ”„ PR Branch - Full Validation Results:"
            echo "ğŸ“ Branch: ${{ github.event.client_payload.gitlab_ref }}"
            echo "ğŸ¯ Testing PR branch code with GitOps pointing to PR changes"
            echo ""
            echo "ğŸ”¹ Minimal Cluster Test: ${{ needs.cluster-minimal.result }}"
            echo "   Status: ${{ needs.cluster-minimal.outputs.flux_status }}"
            echo ""
            echo "ğŸ”¹ Default Cluster Test: ${{ needs.cluster-default.result }}"
            echo "   Status: ${{ needs.cluster-default.outputs.gitops_status }}"
            echo "   Summary: ${{ needs.cluster-default.outputs.reconciliation_summary }}"
          fi
          echo ""

          # Overall status
          overall_status="success"

          # For main branch: check both jobs
          if [ "${{ github.event.client_payload.gitlab_ref }}" = "main" ]; then
            if [ "${{ needs.cluster-minimal.result }}" != "success" ] || [ "${{ needs.cluster-default.result }}" != "success" ]; then
              overall_status="failed"
            fi
          # For PR branches: only check minimal (default is skipped)
          else
            if [ "${{ needs.cluster-minimal.result }}" != "success" ]; then
              overall_status="failed"
            fi
          fi

          if [ "$overall_status" = "success" ]; then
            echo "âœ… All GitOps reconciliation tests passed!"
            echo "âœ… Flux system: HEALTHY"
            echo "âœ… Git sources: RECONCILED"
            echo "âœ… Multi-environment patterns: VALIDATED"
          else
            echo "âŒ Some GitOps reconciliation tests failed"
            echo "âŒ Check individual job logs for details"
          fi
          echo ""

          echo "ğŸ”— Hybrid CI/CD Summary:"
          echo "  â€¢ GitLab CI: Fast validation and tooling checks"
          echo "  â€¢ GitHub Actions: GitOps reconciliation validation"
          echo ""

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸ”— Original GitLab Pipeline: ${{ github.event.client_payload.gitlab_pipeline_url }}"
          fi

          # Set exit code for GitLab feedback
          if [ "$overall_status" = "failed" ]; then
            exit 1
          fi

      - name: Report status back to GitLab
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.gitlab_commit_sha
        run: |
          # Overall status - both jobs must pass for all branches
          overall_status="success"
          if [ "${{ needs.cluster-minimal.result }}" != "success" ] || [ "${{ needs.cluster-default.result }}" != "success" ]; then
            overall_status="failed"
          fi

          # Prepare status message based on branch and result
          if [ "$overall_status" = "success" ]; then
            state="success"
            if [ "${{ github.event.client_payload.gitlab_ref }}" = "main" ]; then
              description="GitOps tests passed: Standard validation (minimal + default clusters)"
            else
              description="GitOps tests passed: PR validation with branch-specific GitOps - Branch: ${{ github.event.client_payload.gitlab_ref }}"
            fi
          else
            state="failed"
            if [ "${{ github.event.client_payload.gitlab_ref }}" = "main" ]; then
              description="GitOps tests failed: Check standard validation logs for details"
            else
              description="GitOps tests failed: Check PR validation logs - Branch: ${{ github.event.client_payload.gitlab_ref }}"
            fi
          fi

          echo "ğŸ“¤ Reporting status back to GitLab..."
          echo "Commit: ${{ github.event.client_payload.gitlab_commit_sha }}"
          echo "Branch: ${{ github.event.client_payload.gitlab_ref }}"
          echo "Status: $state"
          echo "Description: $description"

          # Report to GitLab commit status API
          curl -X POST \
            -H "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://community.opengroup.org/api/v4/projects/1595/statuses/${{ github.event.client_payload.gitlab_commit_sha }}" \
            -d "{
              \"state\": \"$state\",
              \"target_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"description\": \"$description\",
              \"context\": \"github-actions/cluster-testing\"
            }" || echo "âš ï¸ Failed to report to GitLab (non-blocking)"
