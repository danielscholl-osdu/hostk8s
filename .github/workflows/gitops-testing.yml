name: OSDU-CI Cluster Testing

run-name: ${{ github.event_name == 'repository_dispatch' && format('GitLab Pipeline {0} - Cluster Testing', github.event.client_payload.gitlab_pipeline_id) || 'OSDU-CI Cluster Testing' }}

on:
  repository_dispatch:
    types: [gitlab-ci-success]
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'GitOps test scenario to run'
        required: false
        default: 'full'
        type: choice
        options:
          - minimal
          - full
          - gitops

jobs:
  cluster-minimal:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    outputs:
      flux_status: ${{ steps.flux_validation.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log GitLab trigger context
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "üîç GitOps testing triggered by GitLab CI"
          echo "GitLab Pipeline ID: ${{ github.event.client_payload.gitlab_pipeline_id }}"
          echo "GitLab Commit: ${{ github.event.client_payload.gitlab_commit_sha }}"
          echo "GitLab Pipeline URL: ${{ github.event.client_payload.gitlab_pipeline_url }}"

      - name: Create minimal Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: osdu-ci-minimal
          node_image: kindest/node:v1.33.2
          config: infra/kubernetes/kind-config-minimal.yaml

      - name: Install Flux CLI
        run: |
          echo "üì• Installing Flux CLI..."
          curl -s https://fluxcd.io/install.sh | sudo bash
          flux version --client
          echo "‚úÖ Flux CLI installed"

      - name: Bootstrap Flux and test basic reconciliation
        id: flux_validation
        run: |
          echo "üöÄ Testing basic Flux GitOps reconciliation..."

          # Install Flux system
          echo "üì¶ Installing Flux system..."
          flux install --timeout=300s

          # Wait for Flux system to be ready
          echo "‚è≥ Waiting for Flux system readiness..."
          kubectl wait --for=condition=ready pod -l app=source-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=kustomize-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=helm-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=notification-controller -n flux-system --timeout=180s

          # Create basic GitRepository source
          echo "üîó Creating GitRepository source..."
          flux create source git osdu-ci-source \
            --url=https://github.com/danielscholl-osdu/osdu-ci \
            --branch=main \
            --interval=1m \
            --timeout=60s

          # Verify source reconciliation
          echo "‚è≥ Waiting for GitRepository reconciliation..."
          sleep 30
          flux reconcile source git osdu-ci-source --timeout=60s

          # Validate Flux system health
          echo "üìä Flux system status:"
          kubectl get pods -n flux-system
          echo ""

          echo "üìä GitRepository source status:"
          flux get sources git
          echo ""

          # Check for reconciliation success
          if flux get sources git | grep -q "True"; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ Basic Flux reconciliation successful"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå Basic Flux reconciliation failed"
            flux logs --all-namespaces
            exit 1
          fi

  cluster-default:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.inputs.test_scenario != 'minimal' }}
    outputs:
      gitops_status: ${{ steps.gitops_validation.outputs.status }}
      reconciliation_summary: ${{ steps.gitops_validation.outputs.summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Report GitOps testing start to GitLab
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.gitlab_commit_sha
        run: |
          echo "üì§ Reporting GitOps test start to GitLab..."
          curl -X POST \
            -H "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://community.opengroup.org/api/v4/projects/1595/statuses/${{ github.event.client_payload.gitlab_commit_sha }}" \
            -d "{
              \"state\": \"running\",
              \"target_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"description\": \"GitOps reconciliation tests starting...\",
              \"context\": \"github-actions/cluster-testing\"
            }" || echo "‚ö†Ô∏è Failed to report to GitLab (non-blocking)"

      - name: Create full Kind cluster with registry
        uses: helm/kind-action@v1
        with:
          cluster_name: osdu-ci-gitops
          node_image: kindest/node:v1.33.2
          config: infra/kubernetes/kind-config.yaml
          registry: true

      - name: Install additional tools
        run: |
          echo "üì• Installing additional tools..."
          curl -s https://fluxcd.io/install.sh | sudo bash
          helm version && flux version --client
          echo "‚úÖ Additional tools installed"

      - name: Install infrastructure prerequisites
        run: |
          echo "üèóÔ∏è Installing infrastructure prerequisites..."

          # Install MetalLB
          echo "üì¶ Installing MetalLB..."
          kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml
          kubectl wait --namespace metallb-system --for=condition=ready pod --selector=app=metallb --timeout=300s

          # Configure MetalLB IP pool
          kubectl apply -f - <<EOF
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: example
            namespace: metallb-system
          spec:
            addresses:
            - 172.19.255.200-172.19.255.250
          ---
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: empty
            namespace: metallb-system
          EOF

          # Install NGINX Ingress
          echo "üì¶ Installing NGINX Ingress..."
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=300s

          echo "‚úÖ Infrastructure prerequisites installed"

      - name: Test complete GitOps reconciliation
        id: gitops_validation
        run: |
          echo "üöÄ Testing complete GitOps reconciliation..."

          # Install Flux system
          echo "üì¶ Installing Flux system..."
          flux install --timeout=300s

          # Wait for Flux system readiness
          echo "‚è≥ Waiting for Flux system readiness..."
          kubectl wait --for=condition=ready pod -l app=source-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=kustomize-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=helm-controller -n flux-system --timeout=180s
          kubectl wait --for=condition=ready pod -l app=notification-controller -n flux-system --timeout=180s

          # Apply GitOps source configurations
          echo "üîó Applying GitOps source configurations..."
          if [ -d "software/stamp/sources" ]; then
            # Apply only the actual Kubernetes resources, not kustomization.yaml
            find software/stamp/sources -name "*.yaml" ! -name "kustomization.yaml" -exec kubectl apply -f {} \; || echo "No sources directory found, creating basic source"

            # Create basic source if none exists
            flux create source git osdu-ci-source \
              --url=https://github.com/danielscholl-osdu/osdu-ci \
              --branch=main \
              --interval=1m \
              --timeout=60s
          fi

          # Apply GitOps application configurations
          echo "üì¶ Applying GitOps application configurations..."
          if [ -d "software/stamp/apps" ]; then
            # Apply only the actual Kubernetes resources, not kustomization.yaml
            find software/stamp/apps -name "*.yaml" ! -name "kustomization.yaml" -exec kubectl apply -f {} \; || echo "No apps directory found, skipping"
          fi

          # Apply cluster-specific configurations
          echo "üéØ Applying cluster-specific configurations..."
          if [ -d "software/stamp/clusters/osdu-ci" ]; then
            kubectl apply -f software/stamp/clusters/osdu-ci/ || echo "No cluster-specific configs found, skipping"
          fi

          # Wait for reconciliations
          echo "‚è≥ Waiting for source reconciliations..."
          sleep 60

          echo "üîÑ Triggering reconciliations..."
          flux reconcile source git osdu-ci-source --timeout=120s || true
          flux reconcile source git osdu-ci-self --timeout=120s || true
          flux reconcile source helm bitnami --timeout=120s || true
          flux reconcile source helm nginx-stable --timeout=120s || true
          flux reconcile source helm prometheus-community --timeout=120s || true

          # Validate reconciliation status
          echo "üìä GitOps reconciliation status:"
          echo "================================"

          echo "Git Sources:"
          flux get sources git -A
          echo ""

          echo "Helm Sources:"
          flux get sources helm -A || echo "No Helm sources configured"
          echo ""

          echo "Kustomizations:"
          flux get kustomizations -A || echo "No Kustomizations configured"
          echo ""

          echo "Complete GitOps Status:"
          flux get all
          echo ""

          # Check for reconciliation failures
          reconciliation_status="success"
          summary=""

          # Check Git sources for failures (ready=False)
          if flux get sources git -A | grep -E "\s+False\s+" | grep -v "True"; then
            reconciliation_status="failed"
            summary="Git source reconciliation failed"
          # Check Helm sources for failures (ready=False)
          elif flux get sources helm -A 2>/dev/null | grep -E "\s+False\s+" | grep -v "True"; then
            reconciliation_status="failed"
            summary="Helm source reconciliation failed"
          # Check Kustomizations for failures (ready=False)
          elif flux get kustomizations -A 2>/dev/null | grep -E "\s+False\s+" | grep -v "True"; then
            reconciliation_status="failed"
            summary="Kustomization reconciliation failed"
          # Success if all sources are Ready=True
          elif flux get sources git -A | grep -q "True" && flux get sources helm -A | grep -q "True"; then
            summary="GitOps sources reconciled successfully"
          else
            reconciliation_status="failed"
            summary="Unable to determine GitOps reconciliation status"
          fi

          echo "status=$reconciliation_status" >> $GITHUB_OUTPUT
          echo "summary=$summary" >> $GITHUB_OUTPUT

          if [ "$reconciliation_status" = "failed" ]; then
            echo "‚ùå GitOps reconciliation failures detected"
            echo "üîç Flux logs:"
            flux logs --all-namespaces --since=5m
            exit 1
          else
            echo "‚úÖ Complete GitOps reconciliation successful"
          fi

  notify:
    runs-on: ubuntu-latest
    needs: [cluster-minimal, cluster-default]
    if: always()

    steps:
      - name: Report comprehensive GitOps results
        run: |
          echo "üìä GitOps Reconciliation Testing Results:"
          echo "========================================"
          echo ""

          echo "üîπ Minimal Cluster Test: ${{ needs.cluster-minimal.result }}"
          echo "   Status: ${{ needs.cluster-minimal.outputs.flux_status }}"
          echo ""

          echo "üîπ Default Cluster Test: ${{ needs.cluster-default.result }}"
          echo "   Status: ${{ needs.cluster-default.outputs.gitops_status }}"
          echo "   Summary: ${{ needs.cluster-default.outputs.reconciliation_summary }}"
          echo ""

          # Overall status
          overall_status="success"
          if [ "${{ needs.cluster-minimal.result }}" != "success" ] || [ "${{ needs.cluster-default.result }}" != "success" ]; then
            overall_status="failed"
          fi

          if [ "$overall_status" = "success" ]; then
            echo "‚úÖ All GitOps reconciliation tests passed!"
            echo "‚úÖ Flux system: HEALTHY"
            echo "‚úÖ Git sources: RECONCILED"
            echo "‚úÖ Multi-environment patterns: VALIDATED"
          else
            echo "‚ùå Some GitOps reconciliation tests failed"
            echo "‚ùå Check individual job logs for details"
          fi
          echo ""

          echo "üîó Hybrid CI/CD Summary:"
          echo "  ‚Ä¢ GitLab CI: Fast validation and tooling checks"
          echo "  ‚Ä¢ GitHub Actions: GitOps reconciliation validation"
          echo ""

          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "üîó Original GitLab Pipeline: ${{ github.event.client_payload.gitlab_pipeline_url }}"
          fi

          # Set exit code for GitLab feedback
          if [ "$overall_status" = "failed" ]; then
            exit 1
          fi

      - name: Report status back to GitLab
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.gitlab_commit_sha
        run: |
          # Overall status
          overall_status="success"
          if [ "${{ needs.cluster-minimal.result }}" != "success" ] || [ "${{ needs.cluster-default.result }}" != "success" ]; then
            overall_status="failed"
          fi

          # Prepare status message
          if [ "$overall_status" = "success" ]; then
            state="success"
            description="GitOps reconciliation tests passed: Flux healthy, sources reconciled"
          else
            state="failed"
            description="GitOps reconciliation tests failed: Check logs for details"
          fi

          echo "üì§ Reporting status back to GitLab..."
          echo "Commit: ${{ github.event.client_payload.gitlab_commit_sha }}"
          echo "Status: $state"
          echo "Description: $description"

          # Report to GitLab commit status API
          curl -X POST \
            -H "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://community.opengroup.org/api/v4/projects/1595/statuses/${{ github.event.client_payload.gitlab_commit_sha }}" \
            -d "{
              \"state\": \"$state\",
              \"target_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"description\": \"$description\",
              \"context\": \"github-actions/cluster-testing\"
            }" || echo "‚ö†Ô∏è Failed to report to GitLab (non-blocking)"
